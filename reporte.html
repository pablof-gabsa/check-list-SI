<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Checklist SANTA ISABEL 1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-database-compat.js"></script>

    <script>
        tailwind.config = { theme: { extend: { colors: { institutional: '#009999' } } } }
    </script>
    <style>
        @import url('https://rsms.me/inter/inter.css');
        html { font-family: 'Inter', sans-serif; }
        body { background-color: #f3f4f6; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out; }
        .accordion-content.open { max-height: 2000px; transition: max-height 1s ease-in-out; }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-institutional">Checklist temas pendientes SANTA ISABEL 1</h1>
            <p class="text-md text-gray-600 mt-2">Seguimiento interactivo del estado de temas pendientes (Modo solo lectura)</p>
        </header>

        <div id="controls" class="bg-white p-4 rounded-lg shadow-md mb-8 flex items-center justify-between gap-4">
            <div class="flex items-center gap-2">
                <span class="text-gray-600 font-bold">Modo Visualización</span>
            </div>
            <div id="filters" class="flex flex-wrap items-center gap-2">
                <span class="text-sm font-semibold text-gray-600 mr-2">Filtrar:</span>
                <button class="filter-btn active py-1 px-3 rounded-full text-sm transition-colors border" data-filter="Todos">Todos</button>
                <button class="filter-btn py-1 px-3 rounded-full text-sm transition-colors border" data-filter="Pendiente">Pendiente</button>
                <button class="filter-btn py-1 px-3 rounded-full text-sm transition-colors border" data-filter="En Proceso">En Proceso</button>
                <button class="filter-btn py-1 px-3 rounded-full text-sm transition-colors border" data-filter="OK">OK</button>
            </div>
        </div>

        <div id="summary" class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-bold text-gray-700 mb-4">Progreso General <span id="filter-label" class="text-base font-normal text-gray-500"></span></h2>
            <div class="w-full bg-gray-200 rounded-full h-4 mb-4">
                <div id="progressBar" class="bg-institutional h-4 rounded-full transition-all duration-500 ease-out" style="width: 0%;"></div>
            </div>
            <div class="flex flex-col lg:flex-row items-center gap-8 mt-6">
                <div id="stats" class="grid grid-cols-2 sm:grid-cols-3 gap-4 text-center flex-1 order-2 lg:order-1"></div>
                <div class="w-full lg:w-2/3 grid grid-cols-1 md:grid-cols-2 gap-8 order-1 lg:order-2">
                    <div class="h-64 relative">
                        <canvas id="statusChart"></canvas>
                    </div>
                    <div class="h-64 relative">
                        <canvas id="responsibleChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <main id="checklist-container" class="space-y-6"></main>

        <footer class="text-center mt-12 text-sm text-gray-500">
            <p>Los datos se actualizan en tiempo real desde la nube.</p>
        </footer>
    </div>

    <script>
        // --- INICIO DE LA CONFIGURACIÓN DE FIREBASE (SANTA ISABEL 1) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDGZm0nslh4Zdhl294wW9l_wqI2t6bDl04",
            authDomain: "checklist-santa-isabel-1.firebaseapp.com",
            databaseURL: "https://checklist-santa-isabel-1-default-rtdb.firebaseio.com",
            projectId: "checklist-santa-isabel-1",
            storageBucket: "checklist-santa-isabel-1.firebasestorage.app",
            messagingSenderId: "25157813659",
            appId: "1:25157813659:web:291861f913a9bdf5db4d3e"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        // --- FIN DE LA CONFIGURACIÓN DE FIREBASE ---

        let checklistData = [];
        let statusChart = null;
        let responsibleChart = null; 
        let currentFilter = 'Todos';

        const rubros = ['Operativos', 'Obras de infraestructura', 'Administrativos', 'Archivado'];
        const statusOptions = { 'Pendiente': 'bg-yellow-100 text-yellow-800', 'OK': 'bg-green-100 text-green-800', 'En Proceso': 'bg-blue-100 text-blue-800' };
        const statusColors = { 'Pendiente': '#FBBF24', 'OK': '#10B981', 'En Proceso': '#60A5FA' };
        const rubroIcons = {
            'Operativos': `<svg ... omitted for brevity ...></svg>`,
            'Obras de infraestructura': `<svg ... omitted for brevity ...></svg>`,
            'Administrativos': `<svg ... omitted for brevity ...></svg>`,
            'Archivado': `<svg ... omitted for brevity ...></svg>`,
        };
        
        // --- FUNCIÓN DE DATOS (FIREBASE) ---
        function loadData() {
            database.ref('tasks').on('value', (snapshot) => {
                const data = snapshot.val();
                checklistData = data ? (Array.isArray(data) ? data : Object.values(data)) : [];
                renderChecklist();
            });
        }

        // --- LÓGICA DE RENDERIZADO (VERSIÓN SOLO LECTURA) ---
        function renderChecklist() {
            const container = document.getElementById('checklist-container');
            container.innerHTML = '';
            const filteredData = checklistData.filter(item => currentFilter === 'Todos' || item.estado === currentFilter);
            const groupedData = filteredData.reduce((acc, item) => { (acc[item.rubro] = acc[item.rubro] || []).push(item); return acc; }, {});

            rubros.forEach(rubro => {
                const items = groupedData[rubro] || [];
                const accordionItem = document.createElement('div');
                accordionItem.className = 'bg-white rounded-lg shadow-md overflow-hidden';
                const okCount = items.filter(i => i.estado === 'OK').length;
                const header = document.createElement('div');
                header.className = 'p-4 flex justify-between items-center cursor-pointer hover:bg-gray-50';
                header.onclick = () => toggleAccordion(accordionItem);
                header.innerHTML = `<div class="flex items-center">${rubroIcons[rubro] || ''}<h3 class="text-lg font-bold text-gray-700">${rubro}</h3></div><div class="flex items-center space-x-2"><span class="text-sm font-semibold text-gray-600">${okCount}/${items.length}</span><svg class="w-6 h-6 text-gray-500 transition-transform transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div>`;
                const content = document.createElement('div');
                content.className = 'accordion-content border-t border-gray-200';
                
                if (items.length === 0) {
                     content.innerHTML = `<p class="text-center text-gray-500 p-4">No hay tareas en este rubro.</p>`;
                } else {
                    const list = document.createElement('ul');
                    list.className = 'divide-y divide-gray-200';
                    items.forEach(item => {
                        const listItem = document.createElement('li');
                        listItem.className = 'px-4 py-3';
                        const taskRow = document.createElement('div');
                        taskRow.className = 'flex flex-col sm:flex-row items-start sm:items-center gap-x-6 gap-y-2';
                        
                        // Requerimiento como texto plano
                        const requerimientoP = document.createElement('p');
                        requerimientoP.className = 'flex-1 text-gray-800 font-medium';
                        requerimientoP.textContent = item.requerimiento;
                        taskRow.appendChild(requerimientoP);
                        
                        // Responsable como texto plano
                        const responsibleSpan = document.createElement('span');
                        responsibleSpan.className = 'text-sm text-gray-700 w-36';
                        responsibleSpan.innerHTML = `<span class="font-semibold">Resp:</span> ${item.responsable || 'N/A'}`;
                        taskRow.appendChild(responsibleSpan);

                        // Deadline como texto plano
                        const deadlineSpan = document.createElement('span');
                        deadlineSpan.className = 'text-sm text-gray-700';
                        deadlineSpan.innerHTML = `<span class="font-semibold">Vence:</span> ${item.deadline || 'N/A'}`;
                        taskRow.appendChild(deadlineSpan);

                        // Estado como un badge de texto plano
                        const statusBadge = document.createElement('span');
                        statusBadge.textContent = item.estado;
                        statusBadge.className = `px-2 py-1 text-xs font-semibold rounded-full ${statusOptions[item.estado] || 'bg-gray-100'}`;
                        taskRow.appendChild(statusBadge);

                        listItem.appendChild(taskRow);
                        list.appendChild(listItem);
                    });
                    content.appendChild(list);
                }
                accordionItem.appendChild(header);
                accordionItem.appendChild(content);
                container.appendChild(accordionItem);
            });
            updateSummary();
        }
        
        // --- Resto de las funciones (sin cambios en su mayoría) ---
        function updateSummary() {
            const dataToSummarize = checklistData.filter(item => currentFilter === 'Todos' || item.estado === currentFilter);
            const total = dataToSummarize.length;
            const stats = dataToSummarize.reduce((acc, item) => { (acc[item.estado] = (acc[item.estado] || 0) + 1); return acc; }, {});
            const okCount = stats['OK'] || 0;
            const progress = total > 0 ? (okCount / total) * 100 : 0;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('filter-label').textContent = currentFilter !== 'Todos' ? `(Filtro: ${currentFilter})` : '';
            renderPieChart(stats);
            renderResponsibleChart(dataToSummarize);
            const statsContainer = document.getElementById('stats');
            statsContainer.innerHTML = '';
            const fullStats = {'Total': total, 'OK': okCount, ...stats};
            const statOrder = ['Total', 'OK', 'Pendiente', 'En Proceso'];
            statOrder.forEach(key => {
                const value = fullStats[key];
                if (value !== undefined) {
                    const statElement = document.createElement('div');
                    statElement.className = 'p-2 rounded-lg';
                    statElement.innerHTML = `<p class="text-2xl font-bold text-gray-800">${value}</p><p class="text-sm text-gray-600">${key}</p>`;
                    statsContainer.appendChild(statElement);
                }
            });
        }
        function renderPieChart(stats) {
            const ctx = document.getElementById('statusChart').getContext('2d'); if (!ctx) return;
            const filteredLabels = Object.keys(stats).filter(key => stats[key] > 0);
            const filteredData = filteredLabels.map(key => stats[key]);
            const filteredColors = filteredLabels.map(key => statusColors[key] || '#E5E7EB');
            if (statusChart) statusChart.destroy();
            statusChart = new Chart(ctx, { type: 'doughnut', data: { labels: filteredLabels, datasets: [{ data: filteredData, backgroundColor: filteredColors, borderColor: '#fff', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { position: 'right', labels: { boxWidth: 12, padding: 15 } }, title: { display: true, text: 'Tareas por Estado' } } } });
        }
        function renderResponsibleChart(data) {
            const ctx = document.getElementById('responsibleChart').getContext('2d'); if (!ctx) return;
            const responsibleStats = data.reduce((acc, item) => { const responsible = item.responsable.trim() || 'No asignado'; acc[responsible] = (acc[responsible] || 0) + 1; return acc; }, {});
            const labels = Object.keys(responsibleStats);
            const chartData = Object.values(responsibleStats);
            if (responsibleChart) responsibleChart.destroy();
            responsibleChart = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Tareas Asignadas', data: chartData, backgroundColor: 'rgba(0, 153, 153, 0.6)', borderColor: 'rgba(0, 153, 153, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false }, title: { display: true, text: 'Tareas por Responsable' } } } });
        }
        function handleFilterClick(event) {
            const filter = event.target.dataset.filter;
            if (filter) {
                currentFilter = filter;
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                renderChecklist();
            }
        }
        function toggleAccordion(accordionItem) { const content = accordionItem.querySelector('.accordion-content'); const icon = accordionItem.querySelector('svg:last-child'); content.classList.toggle('open'); icon.classList.toggle('rotate-180'); }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('filters').addEventListener('click', handleFilterClick);
            loadData();
        });
    </script>
</body>
</html>